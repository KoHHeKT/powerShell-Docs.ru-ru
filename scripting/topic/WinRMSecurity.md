---
ms.date: 2017-06-05
keywords: "powershell,командлет"
title: WinRMSecurity
redirect_url: https://msdn.microsoft.com/powershell/scripting/setup/winrmsecurity
ms.openlocfilehash: 70d17b2af3207af589fd9e323b8fc9ba3908b220
ms.sourcegitcommit: 598b7835046577841aea2211d613bb8513271a8b
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/08/2017
---
# <a name="powershell-remoting-security-considerations"></a>Вопросы обеспечения безопасности удаленного взаимодействия PowerShell

Удаленное взаимодействие PowerShell — это рекомендуемый способ управления системами Windows. В Windows Server 2012 R2 удаленное взаимодействие PowerShell включено по умолчанию. В этом документе рассматриваются вопросы безопасности и рекомендации по использованию удаленного взаимодействия PowerShell.

## <a name="what-is-powershell-remoting"></a>Что такое удаленное взаимодействие PowerShell?

Функция удаленного взаимодействия PowerShell использует службу [удаленного управления Windows (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426.aspx), которая является реализацией протокола [веб-служб для управления (WS-Managment)](http://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf), чтобы дать пользователям возможность использовать команды PowerShell на удаленных компьютерах. Дополнительные сведения об использовании удаленного взаимодействия PowerShell можно найти в статье [Выполнение удаленных команд](https://technet.microsoft.com/en-us/library/dd819505.aspx).

Удаленное взаимодействие PowerShell отличается от выполнения командлета с параметром **ComputerName** для запуска на удаленном компьютере, когда в качестве базового протокола используется удаленный вызов процедур (RPC).

##  <a name="powershell-remoting-default-settings"></a>Параметры удаленного взаимодействия PowerShell по умолчанию

Удаленное взаимодействие PowerShell (и WinRM) прослушивают следующие порты:

- HTTP — 5985;
- HTTPS — 5986.

По умолчанию функция удаленного взаимодействия PowerShell допускает подключения только от участников группы "Администраторы". Сеансы запускаются в контексте пользователя, поэтому все элементы управления доступом операционной системы, примененные к отдельным пользователям и группам, продолжают применяться к ним при подключении через удаленное взаимодействие PowerShell.

В частных сетях правило брандмауэра Windows по умолчанию для удаленного взаимодействия PowerShell принимает все подключения. В общедоступных сетях правило брандмауэра Windows по умолчанию допускает подключения удаленного взаимодействия PowerShell только из той же подсети. Необходимо явно изменить это правило, чтобы открыть удаленное взаимодействие PowerShell для всех подключений в общедоступной сети.

>**Предупреждение**. Правило брандмауэра для общедоступных сетей предназначено для защиты компьютера от потенциально вредоносных попыток внешних подключений. Будьте внимательны при удалении этого правила.

## <a name="process-isolation"></a>Изоляция процессов

Функция удаленного взаимодействия PowerShell использует службу [удаленного управления Windows (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426) для обмена данными между компьютерами. WinRM выполняется как служба с учетной записью сетевой службы и порождает изолированные процессы, выполняющиеся как учетные записи пользователей, для размещения экземпляров PowerShell. Экземпляр PowerShell, выполняющийся как один пользователь, не имеет доступа к процессу, в котором выполняется экземпляр PowerShell от имени другого пользователя.

## <a name="event-logs-generated-by-powershell-remoting"></a>Журналы событий, создаваемые удаленным взаимодействием PowerShell

Компания FireEye опубликовала хорошую сводку журналов событий и других свидетельств безопасности, создаваемых в сеансах удаленного взаимодействия PowerShell, в статье  
[Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).

## <a name="encryption-and-transport-protocols"></a>Протоколы шифрования и транспорта

Рекомендуется оценивать безопасность подключения удаленного взаимодействия PowerShell с двух точек зрения — начальной аутентификации и текущего обмена данными. 

Независимо от используемого транспортного протокола (HTTP или HTTPS), удаленное взаимодействие PowerShell всегда шифрует весь обмен данными после начальной проверки подлинности с помощью симметричного ключа сеанса AES-256.
    
### <a name="initial-authentication"></a>Начальная проверка подлинности

Проверка подлинности используется для идентификации клиента для сервера и, в идеале, сервера для клиента.
    
Когда клиент подключается к серверу домена по имени компьютера (т. е. server01 или server01.contoso.com), по умолчанию используется протокол аутентификации [Kerberos](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378747.aspx).
Kerberos гарантирует идентификацию пользователя и сервера без отправки каких-либо повторно используемых учетных данных.

Если клиент подключается к серверу домена по IP-адресу (или подключается к серверу рабочей группы), проверка подлинности Kerberos невозможна. В этом случае удаленное взаимодействие PowerShell использует [протокол аутентификации NTLM](https://msdn.microsoft.com/en-us/library/windows/desktop/aa378749.aspx). Протокол аутентификации NTLM гарантирует идентификацию пользователя без отправки каких-либо делегируемых учетных данных. Для подтверждения личности пользователя протокол NTLM требует, чтобы клиент и сервер вычисляли сеансовый ключ на основе пароля пользователя без передачи самого пароля. Серверу, как правило, неизвестен пароль пользователя, поэтому он связывается с контроллером домена, которому пароль пользователя известен и который вычисляет сеансовый ключ для этого сервера. 
      
Протокол NTLM, однако, не гарантирует идентификацию сервера. Как и в случае с любыми протоколами, использующими NTLM для аутентификации, злоумышленник, имеющий доступ к учетной записи компьютера, присоединенного к домену, может заставить контроллер домена вычислить сеансовый ключ NTLM, тем самым олицетворяя сервер.

Проверка подлинности на основе NTLM отключена по умолчанию, однако ее можно разрешить, настроив SSL на целевом сервере или настроив параметр TrustedHosts службы WinRM.
    
#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a>Использование SSL-сертификатов для проверки удостоверения сервера во время NTLM-подключений

Поскольку протокол аутентификации NTLM не может гарантировать идентификацию целевого сервера (а только то, что ему уже известен ваш пароль), можно настроить на целевых серверах использование протокола SSL для удаленного взаимодействия PowerShell. Назначение SSL-сертификата целевому серверу (если он выдан центром сертификации, которому также доверяет клиент) обеспечивает аутентификацию на основе NTLM, которая гарантирует идентификацию как пользователя, так и сервера.
    
#### <a name="ignoring-ntlm-based-server-identity-errors"></a>Пропуск ошибок идентификации сервера на основе NTLM
      
Если реализация развертывания SSL-сертификата на сервере для NTLM-подключений невозможна, отключить связанные ошибки идентификации можно, добавив сервер в список **TrustedHosts**. Обратите внимание, что добавление имени сервера в список TrustedHosts не должно рассматриваться как утверждение о надежности самих узлов, так как протокол аутентификации NTLM не может гарантировать, что подключение на самом деле выполняется к предполагаемому узлу.
Параметр TrustedHosts следует рассматривать как список узлов, для которых требуется отключать ошибки, возникающие из-за невозможности проверить удостоверение сервера.
    
    
### <a name="ongoing-communication"></a>Текущий обмен данными

После завершения начальной аутентификации [протокол удаленного взаимодействия PowerShell](https://msdn.microsoft.com/en-us/library/dd357801.aspx) выполняет шифрование всех текущих подключений с помощью симметричного ключа AES-256 для каждого сеанса.  


## <a name="making-the-second-hop"></a>Выполнение второго перехода

По умолчанию удаленное взаимодействие PowerShell использует для проверки подлинности протокол Kerberos (по возможности) или NTLM. Оба эти протокола выполняют проверку подлинности на удаленном компьютере без отправки учетных данных.
Это наиболее безопасный способ проверки подлинности, но поскольку удаленный компьютер не имеет учетных данных пользователя, он не может получать доступ к другим компьютерам и службам от имени пользователя. Эту ситуацию называют проблемой "двойного перехода".

Существует несколько способов избежать этой проблемы.

### <a name="kerberos-constrained-delegation"></a>Ограниченное делегирование Kerberos

Для высоконадежных серверов можно включить [ограниченное делегирование Kerberos](https://technet.microsoft.com/en-us/library/cc995228.aspx). Это позволит удаленному серверу олицетворять пользователя, прошедшего аутентификацию, для указанного списка компьютеров и служб.

### <a name="trust-between-remote-computers"></a>Доверие между удаленными компьютерами

Если вы доверяете пользователям, выполняющим удаленное подключение к компьютеру *Server1*, доступ к ресурсам на компьютере *Server2*, можно явно предоставить *Server1* доступ к этим ресурсам.

### <a name="use-explicit-credentials-when-accessing-remote-resources"></a>Использование явных учетных данных при доступе к удаленным ресурсам

Можно явным образом передать учетные данные в удаленный ресурс с помощью параметра **Credential** командлета. Например:

```powershell
$myCredential = Get-Credential
New-PSDrive -Name Tools \\Server2\Shared\Tools -Credential $myCredential 
```

### <a name="credssp"></a>CredSSP

Можно использовать [протокол CredSSP](https://msdn.microsoft.com/en-us/library/windows/desktop/bb931352.aspx) для аутентификации, указав CredSSP в качестве значения параметра `Authentication` при вызове командлета [New-PSSession](https://technet.microsoft.com/en-us/library/hh849717.aspx). Протокол CredSSP передает учетные данные на сервер в виде обычного текста, что делает их уязвимыми для атак, направленных на кражу учетных данных. Если безопасность удаленного компьютера нарушена, злоумышленник получает доступ к учетным данным пользователя. Протокол CredSSP по умолчанию отключен на компьютерах клиента и сервера. Включать протокол CredSSP следует только в самых надежных средах. Например, при подключении администратора домена к контроллеру домена, так как контроллер домена является высоконадежным.

Дополнительные сведения о вопросах безопасности при использовании протокола CredSSP для удаленного взаимодействия PowerShell см. в статье [Accidental Sabotage: Beware of CredSSP](http://www.powershellmagazine.com/2014/03/06/accidental-sabotage-beware-of-credssp) (Непреднамеренный саботаж: берегитесь CredSSP).

Дополнительные сведения об атаках, направленных на хищение учетных данных, см. в техническом документе [Mitigating Pass-the-Hash (PtH) Attacks and Other Credential Theft](https://www.microsoft.com/en-us/download/details.aspx?id=36036).








